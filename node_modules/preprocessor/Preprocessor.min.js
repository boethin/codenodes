/*
 Preprocessor.js (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/Preprocessor.js for details
*/
var k=null;
(function(l){function a(a,c){this.source=""+a;this.baseDir="string"==typeof c?c:".";this.f="object"==typeof c?c:{};this.isNode=("undefined"==typeof window||!window.window)&&"function"==typeof require;this.errorSourceAhead=50}a.a=/([ ]*)\/\/[ ]+#(include|ifn?def|if|endif|else|elif|put)/g;a.d=/include[ ]+"([^"\\]*(\\.[^"\\]*)*)"[ ]*\r?(?:\n|$)/g;a.c=/(ifdef|ifndef|if)[ ]*([^\r\n]+)\r?\n/g;a.b=/(endif|else|elif)([ ]+[^\r\n]+)?\r?(?:\n|$)/g;a.e=/put[ ]+([^\n]+)[ ]*/g;a.stripSlashes=function(a){return(a+"").replace(/\\(.?)/g,
function(a,b){switch(b){case "\\":return"\\";case "0":return"\x00";case "":return"";default:return b}})};a.addSlashes=function(a){return(a+"").replace(/([\\"'])/g,"\\$1").replace(/\0/g,"\\0")};a.indent=function(a,c){for(var b=a.split("\n"),e=0;e<b.length;e++)b[e]=c+b[e];return b.join("\n")};a.nlToStr=function(a){return"["+a.replace(/\r/g,"").replace(/\n/g,"\\n")+"]"};a.evaluate=function(g,c){var b=a.addSlashes;return function(a,d){for(var c in a)a.hasOwnProperty(c)&&eval("var "+c+' = "'+b(""+a[c])+
'";');return eval(d)}.call(k,g,c)};a.prototype.process=function(g,c){g=g||{};c="function"==typeof c?c:function(){};c("Defines: "+JSON.stringify(g));for(var b,e,d,h=[];(b=a.a.exec(this.source))!==k;){c(b[2]+" @ "+b.index+"-"+a.a.lastIndex);var f=b[1];switch(b[2]){case "include":a.d.lastIndex=b.index;if((e=a.d.exec(this.source))===k)throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");d=a.stripSlashes(e[1]);c("  incl: "+d);if("undefined"!=typeof this.f[d])d=
this.f[d];else{if(!this.isNode)throw Error("Failed to resolve include: "+this.baseDir+"/"+d);try{e=d,d=require("fs").readFileSync(this.baseDir+"/"+d)+"",this.f[e]=d}catch(l){throw Error("File not found: "+d+" ("+l+")");}}this.source=this.source.substring(0,b.index)+a.indent(d,f)+this.source.substring(a.d.lastIndex);a.a.lastIndex=0<h.length?h[h.length-1].lastIndex:0;c("  continue at "+a.a.lastIndex);break;case "put":a.e.lastIndex=b.index;if((e=a.e.exec(this.source))===k)throw Error("Illegal #"+b[2]+
": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");d=e[1];c("  expr: "+e[1]);d=a.evaluate(g,e[1]);c("  value: "+a.nlToStr(d));this.source=this.source.substring(0,b.index)+f+d+this.source.substring(a.e.lastIndex);a.a.lastIndex=b.index+d.length;c("  continue at "+a.a.lastIndex);break;case "ifdef":case "ifndef":case "if":a.c.lastIndex=b.index;if((e=a.c.exec(this.source))===k)throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");c("  test: "+
e[2]);d="ifdef"==e[1]?!!g[e[2]]:"ifndef"==e[1]?!g[e[2]]:a.evaluate(g,e[2]);c("  value: "+d);h.push(b={include:d,index:b.index,lastIndex:a.c.lastIndex});c("  push: "+JSON.stringify(b));break;case "endif":case "else":case "elif":a.b.lastIndex=b.index;if((e=a.b.exec(this.source))===k)throw Error("Illegal #"+b[2]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");if(0==h.length)throw Error("Unexpected #"+e[1]+": "+this.source.substring(b.index,b.index+this.errorSourceAhead)+"...");
f=h.pop();c("  pop: "+JSON.stringify(f));d=this.source.substring(f.lastIndex,b.index);f.include?(c("  incl: "+a.nlToStr(d)+", 0-"+f.index+" + "+d.length+" bytes + "+a.b.lastIndex+"-"+this.source.length),this.source=this.source.substring(0,f.index)+d+this.source.substring(a.b.lastIndex)):(c("  excl: "+a.nlToStr(d)+", 0-"+f.index+" + "+a.b.lastIndex+"-"+this.source.length),d="",this.source=this.source.substring(0,f.index)+this.source.substring(a.b.lastIndex));""==this.source&&c("  result empty");a.a.lastIndex=
f.index+d.length;c("  continue at "+a.a.lastIndex);if("else"==e[1]||"elif"==e[1])d="else"==e[1]?!f.include:a.evaluate(g,e[2]),h.push(b={include:!f.include,index:a.a.lastIndex,lastIndex:a.a.lastIndex}),c("  push: "+JSON.stringify(b))}}0<h.length&&(f=h.pop(),c("Still on stack: "+JSON.stringify(f)));return this.source};a.prototype.toString=function(){return"Preprocessor"};"undefined"!=typeof module&&module.exports?module.exports=a:"undefined"!=typeof define&&define.amd?define("Preprocessor",[],function(){return a}):
(l.dcodeIO||(l.dcodeIO={}),l.dcodeIO.Preprocessor=a)})(this);
